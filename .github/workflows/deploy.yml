name: ZKTimer Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
    - name: Deploy to GCP
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.REMOTE_HOST }}
        username: ${{ secrets.REMOTE_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        command_timeout: 40m
        script: |
          set -e

          cd /home/ibrahimyldz77/Zkt-Timer

          # 1. Upload izinlerini düzelt (Docker root olarak yazıyor)
          sudo chown -R ibrahimyldz77:ibrahimyldz77 public/uploads/ || true

          # 2. Yeni kodu çek
          git fetch --all
          git reset --hard origin/main

          # 3. Docker temizlik (disk dolmasın)
          docker builder prune -af
          docker image prune -af

          # 4. Build et ve başlat
          docker compose up -d --no-deps --build app-server

          # 5. İzinleri düzelt
          sudo chmod -R 755 public/uploads/

          # 6. Nginx'i yenile
          sudo systemctl reload nginx

          # 7. Container durumunu kontrol et
          echo "Deployment tamamlandı!"
          docker compose ps
          
    - name: Notify on failure
      if: failure()
      run: echo "Deployment failed!"
